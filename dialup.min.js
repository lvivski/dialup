!function(e){"use strict";var t=function(t,n,i,o){function r(e){return i===n.length?i=n.push(e):n[i++]=e,o?void 0:o=!0}function s(){for(var e=0;i>e;)n[e](),n[e++]=void 0;i=0,o=!1}if(n=new Array(1e4),i=0,"function"==typeof setImmediate)t=function(e){r(e)&&setImmediate(s)};else if("object"==typeof process&&process.nextTick)t=function(e){r(e)&&process.nextTick(s)};else if(e.postMessage){var a="__subsequent",c=function(e){e.data===a&&(e.stopPropagation&&e.stopPropagation(),s())};e.addEventListener?e.addEventListener("message",c,!0):e.attachEvent("onmessage",c),t=function(t){r(t)&&e.postMessage(a,"*")}}else t=function(e){r(e)&&setTimeout(s,0)};return t}();"function"==typeof define&&define.amd?define(t):"object"==typeof module&&module.exports?module.exports=t:e.subsequent=e.nextTick=t}(this),function(e){"use strict";function t(e){this.value=e,this.deferreds=[]}function n(e,t,n){var i=e[t],o=e.promise;r(i)?s(function(){try{n=i(n),o.fulfill(n)}catch(e){o.reject(e)}}):o[t](n)}function i(e,t,n){return{promise:e,fulfill:t,reject:n}}function o(e){return e&&"object"==typeof e}function r(e){return e&&"function"==typeof e}if("function"==typeof define&&define.amd)define(t);else if("object"==typeof module&&module.exports){module.exports=t;var s=require("subsequent")}else{e.Davy=e.Promise=t;var s=e.nextTick}t.prototype.isFulfilled=!1,t.prototype.isRejected=!1,t.prototype.then=function(e,o){var r=new t,s=i(r,e,o);return this.isFulfilled||this.isRejected?n(s,this.isFulfilled?t.SUCCESS:t.FAILURE,this.value):this.deferreds.push(s),r},t.prototype.fulfill=function(e){if(!this.isFulfilled&&!this.isRejected){var t=!1;try{if(e===this)throw new TypeError("Can't resolve a promise with itself.");if(o(e)||r(e)){var n=e.then,i=this;if(r(n))return n.call(e,function(e){t||(t=!0,i.fulfill(e))},function(e){t||(t=!0,i.reject(e))}),void 0}this.isFulfilled=!0,this.complete(e)}catch(s){t||this.reject(s)}}},t.prototype.reject=function(e){this.isFulfilled||this.isRejected||(this.isRejected=!0,this.complete(e))},t.prototype.complete=function(e){this.value=e;for(var i=this.isFulfilled?t.SUCCESS:t.FAILURE,o=0;o<this.deferreds.length;++o)n(this.deferreds[o],i,e);this.deferreds=void 0},t.SUCCESS="fulfill",t.FAILURE="reject",t.all=function(){function e(e){a.reject(e)}function n(e){i(f,e)}function i(t,i){return o(i)&&r(i.then)?(i.then(n,e),void 0):(s[t]=i,0===--c&&a.fulfill(s),void 0)}for(var s=[].slice.call(1===arguments.length&&Array.isArray(arguments[0])?arguments[0]:arguments),a=new t,c=s.length,f=0;f<s.length;++f)i(f,s[f]);return a}}(this),function(e){"use strict";function t(){this.listeners=[]}function n(e,t){d(function(){e(t)})}function i(e){t.call(this),e.listen(this.add.bind(this))}function o(e,t){i.call(this,e),this.convert=t}function r(e,t){i.call(this,e),this.test=t}function s(e,t){i.call(this,e),this.expand=t}function a(e,t){i.call(this,e),this.count=t}function c(e,t){i.call(this,e),this.count=t}function f(e,n){var i=new t;return e.addEventListener(n,i.add.bind(i),!1),i}if("function"==typeof define&&define.amd)define(t);else if("object"==typeof module&&module.exports){module.exports=t;var d=require("subsequent")}else{e.Stream=t;var d=e.nextTick}t.prototype.add=function(e){for(var t=0;t<this.listeners.length;++t)n(this.listeners[t],e)},t.prototype.listen=function(e){this.listeners.push(e)},t.prototype.map=function(e){return new o(this,e)},o.prototype=Object.create(t.prototype),o.prototype.add=function(e){e=this.convert(e),t.prototype.add.call(this,e)},t.prototype.filter=function(e){return new r(this,e)},r.prototype=Object.create(t.prototype),r.prototype.add=function(e){this.test(e)&&t.prototype.add.call(this,e)},t.prototype.expand=function(e){return new s(this,e)},s.prototype=Object.create(t.prototype),s.prototype.add=function(e){e=this.expand(e);for(var n in e)t.prototype.add.call(this,e[n])},t.prototype.take=function(e){return new a(this,e)},a.prototype=Object.create(t.prototype),a.prototype.add=function(e){this.count-->0&&t.prototype.add.call(this,e)},t.prototype.skip=function(e){return new c(this,e)},c.prototype=Object.create(t.prototype),c.prototype.add=function(e){this.count-->0||t.prototype.add.call(this,e)},"undefined"!=typeof window&&(window.on=Node.prototype.on=function(e){return new f(this,e)})}(this),function(e){"use strict";function t(e,t){function n(e,t){t.createOffer(function(n){t.setLocalDescription(n),u("offer",{id:parseInt(e),description:{sdp:n.sdp,type:n.type}})},function(){})}function a(e,t){t.createAnswer(function(n){t.setLocalDescription(n),u("answer",{id:e,description:{sdp:n.sdp,type:n.type}})},function(){})}function c(e,t,n){var i=t.createDataChannel(n||"fileTransfer",{reliable:!1});f(e,i)}function f(e,t){t.onopen=function(){},t.onmessage=function(t){v.add({type:"data",id:e,data:t.data})},t.onclose=function(){},y[e]=t}function d(e){var t=new i({iceServers:[{url:"stun:stun.l.google.com:19302"}]},{optional:[{RtpDataChannels:!0},{DtlsSrtpKeyAgreement:!0}]});return t.onicecandidate=function(t){null!=t.candidate&&u("candidate",{label:t.candidate.sdpMLineIndex,id:e,candidate:t.candidate.candidate})},t.onaddstream=function(t){v.add({type:"add",id:e,stream:t.stream})},t.onremovestream=function(t){v.add({type:"remove",id:e,stream:t.stream})},t.ondatachannel=function(t){f(e,t.channel)},t}function u(e,t){t.type=e,w.send(JSON.stringify(t))}var p=null,l=[],h={},y={},m=[],v=new Stream,w=new WebSocket(e);w.onopen=function(){u("join",{room:t||""})},w.onerror=function(){},w.onmessage=function(e){v.add(JSON.parse(e.data))},this.onOffer=v.filter(function(e){return"offer"===e.type}),this.onAnswer=v.filter(function(e){return"answer"===e.type}),this.onCandidate=v.filter(function(e){return"candidate"===e.type}),this.onNew=v.filter(function(e){return"new"===e.type}),this.onPeers=v.filter(function(e){return"peers"===e.type}),this.onLeave=v.filter(function(e){return"leave"===e.type}),this.onAdd=v.filter(function(e){return"add"===e.type}),this.onRemove=v.filter(function(e){return"remove"===e.type}),this.onData=v.filter(function(e){return"data"===e.type}),this.send=function(e){for(var t in y){var n=y[t];n.send(e)}},this.createStream=function(e,t){var i=new Promise;return o({audio:e,video:t},function(e){m.push(e);for(var t=0;t<l.length;++t){var o=l[t];h[o]=d(o)}for(t=0;t<m.length;++t){var e=m[t];for(var o in h){var r=h[o];r.addStream(e)}}for(o in h)r=h[o],c(o,r),n(o,r);i.fulfill(e)},function(){}),i},this.onPeers.listen(function(e){p=parseInt(e.you,10);for(var t in e.connections){var n=e.connections[t];l.push(n)}}),this.onCandidate.listen(function(e){var t=new r({sdpMLineIndex:e.label,candidate:e.candidate});h[e.id].addIceCandidate(t)}),this.onNew.listen(function(e){var t=e.id,n=d(t);l.push(t),h[t]=n,m.forEach(function(e){n.addStream(e)})}),this.onLeave.listen(function(e){var t=e.id;delete h[t],delete y[t],delete l[t]}),this.onOffer.listen(function(e){var t=h[e.id];t.setRemoteDescription(new s(e.description)),a(e.id,t)}),this.onAnswer.listen(function(e){var t=h[e.id];t.setRemoteDescription(new s(e.description))})}var n=e.navigator,i=e.PeerConnection||e.webkitPeerConnection00||e.webkitRTCPeerConnection||e.mozRTCPeerConnection,o=(n.getUserMedia||n.webkitGetUserMedia||n.mozGetUserMedia||n.msGetUserMedia||noop).bind(n),r=e.mozRTCIceCandidate||e.RTCIceCandidate,s=e.mozRTCSessionDescription||e.RTCSessionDescription;e.URL=e.URL||e.webkitURL||e.msURL,"function"==typeof define&&define.amd?define(t):"object"==typeof module&&module.exports?module.exports=t:e.Dialup=t}(this);
//# sourceMappingURL=dialup.min.js.map