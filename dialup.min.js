!function(e){"use strict";var r,h,v;function i(e,n){var c=[],d={},t={},s=[],i=r.control(),o=i.stream,a=new WebSocket(e),f={offerToReceiveAudio:!0,offerToReceiveVideo:!0};function u(n,e){e.onopen=function(){},e.onmessage=function(e){i.add({type:"data",id:n,data:e.data})},e.onclose=function(){},t[n]=e}function l(n){var e=new RTCPeerConnection;return e.onicecandidate=function(e){null!=e.candidate&&p("candidate",{label:e.candidate.sdpMLineIndex,id:n,candidate:e.candidate.candidate})},e.oniceconnectionstatechange=function(){switch(e.iceConnectionState){case"disconnected":case"failed":e.close();break;case"completed":e.onicecandidate=function(){}}},e.ontrack=function(e){i.add({type:"add",id:n,stream:e.streams[0]})},e.ondatachannel=function(e){u(n,e.channel)},e}function p(e,n){n.type=e,a.send(JSON.stringify(n))}a.onopen=function(){p("join",{room:n||""})},a.onerror=function(){},a.onmessage=function(e){i.add(JSON.parse(e.data))},this.onOffer=o.filter(function(e){return"offer"===e.type}),this.onAnswer=o.filter(function(e){return"answer"===e.type}),this.onCandidate=o.filter(function(e){return"candidate"===e.type}),this.onNew=o.filter(function(e){return"new"===e.type}),this.onPeers=o.filter(function(e){return"peers"===e.type}),this.onLeave=o.filter(function(e){return"leave"===e.type}),this.onAdd=o.filter(function(e){return"add"===e.type}),this.onRemove=o.filter(function(e){return"remove"===e.type}),this.onData=o.filter(function(e){return"data"===e.type}),this.broadcast=function(e){for(var n in t)this.send(n,e)},this.send=function(e,n){e=t[e];"open"===e.readyState&&e.send(n)},this.createStream=function(e,n){var r=h.defer();return navigator.mediaDevices.getUserMedia({audio:e,video:n}).then(function(n){v.filter(n),s.push(n);for(var e,t,i=0;i<c.length;++i){var o=c[i];d[o]=l(o)}for(i=0;i<s.length;++i)for(o in n=s[i],d){var a=d[o];n.getTracks().forEach(function(e){a.addTrack(e,n)})}for(o in d)a=d[o],e=o,t=(t=void 0)||"dataChannel",t=a.createDataChannel(t),u(e,t),function(n,t){t.createOffer(f).then(function(e){t.setLocalDescription(e).then(function(){p("offer",{id:n,description:{sdp:e.sdp,type:e.type}})})},function(){})}(o,a);r.fulfill(n)}),r.promise},this.onPeers.listen(function(e){for(var n in e.you,e.connections){n=e.connections[n];c.push(n)}}),this.onCandidate.listen(function(e){var n=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});d[e.id].addIceCandidate(n).catch(function(e){console.log(e)})}),this.onNew.listen(function(e){var e=e.id,t=l(e);c.push(e),d[e]=t,s.forEach(function(n){n.getTracks().forEach(function(e){t.addTrack(e,n)})})}),this.onLeave.listen(function(e){e=e.id;delete d[e],delete t[e],c.splice(c.indexOf(e),1)}),this.onOffer.listen(function(e){var n,t,i=d[e.id];i.setRemoteDescription(new RTCSessionDescription(e.description)),n=e.id,(t=i).createAnswer().then(function(e){t.setLocalDescription(e),p("answer",{id:n,description:{sdp:e.sdp,type:e.type}})},function(){})}),this.onAnswer.listen(function(e){d[e.id].setRemoteDescription(new RTCSessionDescription(e.description))})}"Window"!=typeof e&&(e=window),"function"==typeof define&&define.amd?define(["streamlet","davy","overtone"],function(e,n,t){return r=e,h=n,v=t,i}):v="object"==typeof module&&module.exports?(module.exports=i,r=require("streamlet"),h=require("davy"),require("overtone")):(e.Dialup=i,r=e.Streamlet,h=e.Davy,e.Overtone)}(this);