!function(e){"use strict";var a,h;function o(e){return e.replace(/^stun\d*\./,"").replace(/:\d+$/,"")}function c(e,n){const t=a.control(),o=t.stream,i=new WebSocket(e);function c(e,n){n.type=e,i.send(JSON.stringify(n))}i.onopen=function(){c("join",{room:n||""})},i.onerror=function(){},i.onmessage=function(e){t.add(JSON.parse(e.data))},this.send=c,this.onOffer=o.filter(e=>"offer"===e.type),this.onAnswer=o.filter(e=>"answer"===e.type),this.onCandidate=o.filter(e=>"candidate"===e.type),this.onNew=o.filter(e=>"new"===e.type),this.onPeers=o.filter(e=>"peers"===e.type),this.onLeave=o.filter(e=>"leave"===e.type)}"Window"!=typeof e&&(e=window),"function"==typeof define&&define.amd?define(["streamlet","overtone"],function(e,n){return a=e,h=n,t}):h="object"==typeof module&&module.exports?(module.exports=t,a=require("streamlet"),require("overtone")):(e.Dialup=t,a=e.Streamlet,e.Overtone),e=["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302","stun.ekiga.net","stun.ideasip.com","stun.rixtelecom.se","stun.schlund.de","stun.stunprotocol.org:3478","stun.voiparound.com","stun.voipbuster.com","stun.voipstunt.com","stun.voxgratia.org"].reduce(function(e,n){var t=e[e.length-1];return n="stun:"+n,t&&o(t.urls[0])===o(n)?t.urls.push(n):e.push({urls:[n]}),e},[]);const m={offerToReceiveAudio:!0,offerToReceiveVideo:!0},s={iceServers:e};function t(e,n){const r=new c(e,n),d=[],u={},o={},f=[],t=a.control(),i=t.stream;function l(n,e){e.onopen=function(){},e.onmessage=function(e){t.add({id:n,type:"data",data:e.data})},e.onclose=function(){},o[n]=e}function p(n){const e=new RTCPeerConnection(s);return e.onicecandidate=function(e){e.candidate&&e.candidate.candidate&&r.send("candidate",{id:n,label:e.candidate.sdpMLineIndex,candidate:e.candidate.candidate})},e.oniceconnectionstatechange=function(){switch(e.iceConnectionState){case"disconnected":case"failed":e.close();break;case"completed":e.onicecandidate=function(){}}},e.onicecandidateerror=function(e){console.log(e)},e.ontrack=function(e){t.add({id:n,type:"add",stream:e.streams[0]})},e.ondatachannel=function(e){l(n,e.channel)},e}this.onAdd=i.filter(e=>"add"===e.type),this.onData=i.filter(e=>"data"===e.type),this.onPeers=r.onPeers,this.onLeave=r.onLeave,this.broadcast=function(e){for(const n in o)this.send(n,e)},this.send=function(e,n){const t=o[e];"open"===t.readyState&&t.send(n)},this.createStream=function(e,n){return navigator.mediaDevices.getUserMedia({audio:e,video:n}).then(function(n){h.filter(n),f.push(n);for(const i of d)u[i]=p(i);for(const n of f)for(const c in u){const a=u[c];n.getTracks().forEach(function(e){a.addTrack(e,n)})}for(const s in u){var e=u[s];t=s,o=(o=void 0)||"dataChannel",o=e.createDataChannel(o),!void l(t,o),function(e,n){n.createOffer(m).then(e=>n.setLocalDescription(e)).then(()=>r.send("offer",{id:e,description:n.localDescription}),function(){})}(s,e)}var t,o;return n})},r.onPeers.listen(function(e){e.you;for(const n of e.connections)d.push(n)}),r.onCandidate.listen(function(e){var n=e.id,e=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});u[n].addIceCandidate(e)}),r.onNew.listen(function(e){e=e.id;const t=p(e);d.push(e),u[e]=t,f.forEach(function(n){n.getTracks().forEach(function(e){t.addTrack(e,n)})})}),r.onLeave.listen(function(e){e=e.id;delete u[e],delete o[e],d.splice(d.indexOf(e),1)}),r.onOffer.listen(function(e){var n,t,o=e.id;const i=u[o];i.setRemoteDescription(e.description),n=o,(t=i).createAnswer().then(e=>t.setLocalDescription(e)).then(()=>r.send("answer",{id:n,description:t.localDescription}),function(){})}),r.onAnswer.listen(function(e){var n=e.id;const t=u[n];t.setRemoteDescription(e.description)})}}(this);