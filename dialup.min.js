!function(e){"use strict";var p,h;function o(e){return e.replace(/^stun:stun\d*\./,"").replace(/:\d+$/,"")}function m(e,n){const t=p.control(),o=t.stream,i=new WebSocket(e);function s(e,n){n.type=e,i.send(JSON.stringify(n))}i.onopen=function(){s("join",{room:n||""})},i.onerror=function(){},i.onmessage=function(e){t.add(JSON.parse(e.data))},this.send=s,this.onJoin=o.filter(e=>"join"===e.type),this.onOffer=o.filter(e=>"offer"===e.type),this.onAnswer=o.filter(e=>"answer"===e.type),this.onPeers=o.filter(e=>"peers"===e.type),this.onNew=o.filter(e=>"new"===e.type),this.onCandidate=o.filter(e=>"candidate"===e.type),this.onLeave=o.filter(e=>"leave"===e.type)}"Window"!=typeof e&&(e=window),"function"==typeof define&&define.amd?define(["streamlet","overtone"],function(e,n){return p=e,h=n,t}):h="object"==typeof module&&module.exports?(module.exports=t,p=require("streamlet"),require("overtone")):(e.Dialup=t,p=e.Streamlet,e.Overtone),e=["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302","stun.ekiga.net","stun.ideasip.com","stun.rixtelecom.se","stun.schlund.de","stun.stunprotocol.org:3478","stun.voiparound.com","stun.voipbuster.com","stun.voipstunt.com","stun.voxgratia.org"].reduce(function(e,n){n="stun:"+n;var t=e[e.length-1];return t&&o(t.urls[0])===o(n)?t.urls.push(n):e.push({urls:[n]}),e},[]);const g={offerToReceiveAudio:!0,offerToReceiveVideo:!0},v={iceServers:e};function t(e,n){const s=new m(e,n),c=[],a=[],r={},o={},i={},t=p.control(),d=t.stream;function u(n,t,o){i[n]||(i[n]=[]),o.getTracks().forEach(function(e){i[n].push(t.addTrack(e,o))})}function f(n,e){e.onopen=function(){},e.onmessage=function(e){t.add({id:n,type:"data",data:e.data})},e.onclose=function(){},o[n]=e}function l(o){const i=new RTCPeerConnection(v);return r[o]=i,i.onicecandidate=function(e){e.candidate&&e.candidate.candidate&&s.send("candidate",{id:o,candidate:e.candidate})},i.oniceconnectionstatechange=function(){switch(i.iceConnectionState){case"disconnected":case"failed":i.close();break;case"completed":i.onicecandidate=function(){}}},i.onicecandidateerror=function(e){console.log(e)},i.onnegotiationneeded=function(e){var n,t;n=o,(t=i).createOffer(g).then(e=>t.setLocalDescription(e)).then(()=>s.send("offer",{id:n,description:t.localDescription}),function(){})},i.ontrack=function(e){t.add({id:o,type:"add",stream:e.streams[0]})},i.ondatachannel=function(e){f(o,e.channel)},i}this.onAdd=d.filter(e=>"add"===e.type),this.onData=d.filter(e=>"data"===e.type),this.onPeers=s.onPeers,this.onLeave=s.onLeave,this.broadcast=function(e){for(const n in o)this.send(n,e)},this.send=function(e,n){const t=o[e];"open"===t.readyState&&t.send(n)},this.getUserStream=function(e,n){return navigator.mediaDevices.getUserMedia({audio:e,video:!!n&&{facingMode:"user"}}).then(function(e){h.filter(e),a.push(e);for(const t of c){var n=r[t];u(t,n,e)}return e})},this.getDisplayStream=function(){return navigator.mediaDevices.getDisplayMedia().then(function(e){a.push(e);for(const t of c){var n=r[t];u(t,n,e)}return e})},this.stopStream=function(e){e.getTracks().forEach(function(e){e.stop()})},s.onPeers.listen(function(e){e.you;for(const n of e.connections)c.push(n),l(n)}),s.onNew.listen(function(e){var n=e.id;c.push(n);var t,o=l(n);e=n,t=t||"dataChannel",t=o.createDataChannel(t),f(e,t);for(const i of a)u(n,o,i)}),s.onCandidate.listen(function(e){var n=e.id;r[n].addIceCandidate(e.candidate)}),s.onLeave.listen(function(e){e=e.id;delete r[e],delete o[e],delete i[e],c.splice(c.indexOf(e),1)}),s.onOffer.listen(function(e){var n,t,o=e.id;const i=r[o];i.setRemoteDescription(e.description),n=o,(t=i).createAnswer().then(e=>t.setLocalDescription(e)).then(()=>s.send("answer",{id:n,description:t.localDescription}),function(){})}),s.onAnswer.listen(function(e){var n=e.id;const t=r[n];t.setRemoteDescription(e.description)})}}(this);