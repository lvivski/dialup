!function(e){"use strict";var v,m,y;function i(e,n){var c=[],d={},t={},s=[],i=v.control(),o=i.stream,a=new WebSocket(e),f={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},r={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},u={optional:[{DtlsSrtpKeyAgreement:!0}]};function l(n,e){e.onopen=function(){},e.onmessage=function(e){i.add({type:"data",id:n,data:e.data})},e.onclose=function(){},t[n]=e}function p(n){var e=new RTCPeerConnection(r,u);return e.onicecandidate=function(e){null!=e.candidate&&e.candidate.candidate&&h("candidate",{label:e.candidate.sdpMLineIndex,id:n,candidate:e.candidate.candidate})},e.oniceconnectionstatechange=function(){switch(e.iceConnectionState){case"disconnected":case"failed":e.close();break;case"completed":e.onicecandidate=function(){}}},e.ontrack=function(e){i.add({type:"add",id:n,stream:e.streams[0]})},e.onremovestream=function(e){i.add({type:"remove",id:n,stream:e.stream})},e.ondatachannel=function(e){l(n,e.channel)},e}function h(e,n){n.type=e,a.send(JSON.stringify(n))}a.onopen=function(){h("join",{room:n||""})},a.onerror=function(){},a.onmessage=function(e){i.add(JSON.parse(e.data))},this.onOffer=o.filter(function(e){return"offer"===e.type}),this.onAnswer=o.filter(function(e){return"answer"===e.type}),this.onCandidate=o.filter(function(e){return"candidate"===e.type}),this.onNew=o.filter(function(e){return"new"===e.type}),this.onPeers=o.filter(function(e){return"peers"===e.type}),this.onLeave=o.filter(function(e){return"leave"===e.type}),this.onAdd=o.filter(function(e){return"add"===e.type}),this.onRemove=o.filter(function(e){return"remove"===e.type}),this.onData=o.filter(function(e){return"data"===e.type}),this.broadcast=function(e){for(var n in t)this.send(n,e)},this.send=function(e,n){e=t[e];"open"===e.readyState&&e.send(n)},this.createStream=function(e,n){var r=m.defer();return navigator.mediaDevices.getUserMedia({audio:e,video:n}).then(function(n){y.filter(n),s.push(n);for(var e,t,i=0;i<c.length;++i){var o=c[i];d[o]=p(o)}for(i=0;i<s.length;++i)for(o in n=s[i],d){var a=d[o];console.log(a),n.getTracks().forEach(function(e){a.addTrack(e,n)})}for(o in d)a=d[o],e=o,t=(t=void 0)||"dataChannel",t=a.createDataChannel(t,{reliable:!0}),l(e,t),function(n,t){t.createOffer(function(e){t.setLocalDescription(e),h("offer",{id:n,description:{sdp:e.sdp,type:e.type}})},function(){},f)}(o,a);r.fulfill(n)},function(){},f),r.promise},this.onPeers.listen(function(e){for(var n in e.you,e.connections){n=e.connections[n];c.push(n)}}),this.onCandidate.listen(function(e){var n=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});console.log(e,n),d[e.id].addIceCandidate(n)}),this.onNew.listen(function(e){var e=e.id,n=p(e);c.push(e),d[e]=n,s.forEach(function(e){n.addStream(e)})}),this.onLeave.listen(function(e){e=e.id;delete d[e],delete t[e],c.splice(c.indexOf(e),1)}),this.onOffer.listen(function(e){var n,t,i=d[e.id];i.setRemoteDescription(new RTCSessionDescription(e.description)),n=e.id,(t=i).createAnswer(function(e){t.setLocalDescription(e),h("answer",{id:n,description:{sdp:e.sdp,type:e.type}})},function(){})}),this.onAnswer.listen(function(e){d[e.id].setRemoteDescription(new RTCSessionDescription(e.description))})}"Window"!=typeof e&&(e=window),"function"==typeof define&&define.amd?define(["streamlet","davy","overtone"],function(e,n,t){return v=e,m=n,y=t,i}):y="object"==typeof module&&module.exports?(module.exports=i,v=require("streamlet"),m=require("davy"),require("overtone")):(e.Dialup=i,v=e.Streamlet,m=e.Davy,e.Overtone)}(this);