!function(e){"use strict";var l,p;function o(e){return e.replace(/^stun:stun\d*\./,"").replace(/:\d+$/,"")}function h(e,n){const t=l.control(),o=t.stream,i=new WebSocket(e);function a(e,n){n.type=e,i.send(JSON.stringify(n))}i.onopen=function(){a("join",{room:n||""})},i.onerror=function(){},i.onmessage=function(e){t.add(JSON.parse(e.data))},this.send=a,this.onJoin=o.filter(e=>"join"===e.type),this.onOffer=o.filter(e=>"offer"===e.type),this.onAnswer=o.filter(e=>"answer"===e.type),this.onPeers=o.filter(e=>"peers"===e.type),this.onNew=o.filter(e=>"new"===e.type),this.onCandidate=o.filter(e=>"candidate"===e.type),this.onLeave=o.filter(e=>"leave"===e.type)}"Window"!=typeof e&&(e=window),"function"==typeof define&&define.amd?define(["streamlet","overtone"],function(e,n){return l=e,p=n,t}):p="object"==typeof module&&module.exports?(module.exports=t,l=require("streamlet"),require("overtone")):(e.Dialup=t,l=e.Streamlet,e.Overtone);const y={iceServers:["stun.l.google.com:19302"].reduce(function(e,n){n="stun:"+n;var t=e[e.length-1];return t&&o(t.urls[0])===o(n)?t.urls.push(n):e.push({urls:[n]}),e},[])};function t(e,n){const i=new h(e,n),a=[],c=[],s={},o={},t=l.control(),r=t.stream;function d(e,n){const t=s[e];for(const o of n.getTracks())t.addTrack(o,n)}this.onAdd=r.filter(e=>"add"===e.type),this.onData=r.filter(e=>"data"===e.type),this.onPeers=i.onPeers,this.onLeave=i.onLeave,this.broadcast=function(e){for(const n in o)this.send(n,e)},this.send=function(e,n){const t=o[e];"open"===t.readyState&&t.send(n)},this.getUserStream=async function(e,n){var t=await navigator.mediaDevices.getUserMedia({audio:e,video:!!n&&{facingMode:"user"}});c.push(t),p.filter(t);for(const o of a)d(o,t);return t},this.getDisplayStream=async function(){var e=await navigator.mediaDevices.getDisplayMedia();c.push(e);for(const n of a)d(n,e);return e},this.stopStream=function(e){for(const n of e.getTracks())n.stop();c.splice(c.indexOf(e),1)},i.onPeers.listen(function(e){e.you;for(const n of e.connections)a.push(n),u(n),function(e,n){n=n||"dataChannel";const t=s[e],o=t.createDataChannel(n);f(e,o)}(n)}),i.onNew.listen(function(e){e=e.id;a.push(e),u(e)}),i.onCandidate.listen(function(e){var n=e.id;const t=s[n];t.addIceCandidate(e.candidate)}),i.onLeave.listen(function(e){e=e.id;delete s[e],delete o[e],a.splice(a.indexOf(e),1)}),i.onOffer.listen(async function(e){var n=e.id;const t=s[n];if(await t.setRemoteDescription(e.description),"new"===t.iceConnectionState)for(const o of c)d(n,o);await async function(e){const n=s[e];await n.setLocalDescription(await n.createAnswer()),i.send("answer",{id:e,description:n.localDescription})}(n)}),i.onAnswer.listen(async function(e){var n=e.id;const t=s[n];await t.setRemoteDescription(e.description)});function f(n,e){e.onopen=function(){},e.onmessage=function(e){t.add({id:n,type:"data",data:e.data})},e.onclose=function(){},o[n]=e}function u(n){const e=new RTCPeerConnection(y);return s[n]=e,e.onicecandidate=function(e){e.candidate&&e.candidate.candidate&&i.send("candidate",{id:n,candidate:e.candidate})},e.oniceconnectionstatechange=function(){switch(e.iceConnectionState){case"disconnected":break;case"failed":e.close();break;case"completed":e.onicecandidate=function(){}}},e.onicecandidateerror=function(e){console.log(e)},e.onnegotiationneeded=function(){!async function(e){const n=s[e];await n.setLocalDescription(await n.createOffer()),i.send("offer",{id:e,description:n.localDescription})}(n)},e.ontrack=function(e){t.add({id:n,type:"add",stream:e.streams[0]})},e.ondatachannel=function(e){f(n,e.channel)},e}}}(this);