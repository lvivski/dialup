!function(e){"use strict";var h,v,m;"Window"!=typeof e&&(e=window),"function"==typeof define&&define.amd?define(["streamlet","davy","overtone"],function(e,n,t){return h=e,v=n,m=t,i}):m="object"==typeof module&&module.exports?(module.exports=i,h=require("streamlet"),v=require("davy"),require("overtone")):(e.Dialup=i,h=e.Streamlet,v=e.Davy,e.Overtone);var g=["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302","stun.ekiga.net","stun.ideasip.com","stun.rixtelecom.se","stun.schlund.de","stun.stunprotocol.org:3478","stun.voiparound.com","stun.voipbuster.com","stun.voipstunt.com","stun.voxgratia.org"].reduce(function(e,n){var t=e[e.length-1];return n="stun:"+n,t&&o(t.urls[0])===o(n)?t.urls.push(n):e.push({urls:[n]}),e},[]);function o(e){return e.replace(/^stun\d*\./,"").replace(/:\d+$/,"")}function i(e,n){var a=[],s={},t={},d=[],o=h.control(),i=o.stream,r=new WebSocket(e),u={offerToReceiveAudio:!0,offerToReceiveVideo:!0},c={iceServers:g};function f(n,e){e.onopen=function(){},e.onmessage=function(e){o.add({type:"data",id:n,data:e.data})},e.onclose=function(){},t[n]=e}function l(n){console.log(c);var e=new RTCPeerConnection(c);return e.onicecandidate=function(e){null!=e.candidate&&p("candidate",{label:e.candidate.sdpMLineIndex,id:n,candidate:e.candidate.candidate})},e.oniceconnectionstatechange=function(){switch(e.iceConnectionState){case"disconnected":case"failed":e.close();break;case"completed":e.onicecandidate=function(){}}},e.onicecandidateerror=function(e){console.log(e)},e.ontrack=function(e){o.add({type:"add",id:n,stream:e.streams[0]})},e.ondatachannel=function(e){f(n,e.channel)},e}function p(e,n){n.type=e,r.send(JSON.stringify(n))}console.log(c),r.onopen=function(){p("join",{room:n||""})},r.onerror=function(){},r.onmessage=function(e){o.add(JSON.parse(e.data))},this.onOffer=i.filter(function(e){return"offer"===e.type}),this.onAnswer=i.filter(function(e){return"answer"===e.type}),this.onCandidate=i.filter(function(e){return"candidate"===e.type}),this.onNew=i.filter(function(e){return"new"===e.type}),this.onPeers=i.filter(function(e){return"peers"===e.type}),this.onLeave=i.filter(function(e){return"leave"===e.type}),this.onAdd=i.filter(function(e){return"add"===e.type}),this.onRemove=i.filter(function(e){return"remove"===e.type}),this.onData=i.filter(function(e){return"data"===e.type}),this.broadcast=function(e){for(var n in t)this.send(n,e)},this.send=function(e,n){e=t[e];"open"===e.readyState&&e.send(n)},this.createStream=function(e,n){var c=v.defer();return navigator.mediaDevices.getUserMedia({audio:e,video:n}).then(function(n){m.filter(n),d.push(n);for(var e,t,o=0;o<a.length;++o){var i=a[o];s[i]=l(i)}for(o=0;o<d.length;++o)for(i in n=d[o],s){var r=s[i];n.getTracks().forEach(function(e){r.addTrack(e,n)})}for(i in s)r=s[i],e=i,t=(t=void 0)||"dataChannel",t=r.createDataChannel(t),f(e,t),function(n,t){t.createOffer(u).then(function(e){t.setLocalDescription(e).then(function(){p("offer",{id:n,description:{sdp:e.sdp,type:e.type}})})},function(){})}(i,r);c.fulfill(n)}),c.promise},this.onPeers.listen(function(e){for(var n in e.you,e.connections){n=e.connections[n];a.push(n)}}),this.onCandidate.listen(function(e){var n=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});s[e.id].addIceCandidate(n).catch(function(e){console.log(e)})}),this.onNew.listen(function(e){var e=e.id,t=l(e);a.push(e),s[e]=t,d.forEach(function(n){n.getTracks().forEach(function(e){t.addTrack(e,n)})})}),this.onLeave.listen(function(e){e=e.id;delete s[e],delete t[e],a.splice(a.indexOf(e),1)}),this.onOffer.listen(function(e){var n,t,o=s[e.id];o.setRemoteDescription(new RTCSessionDescription(e.description)),n=e.id,(t=o).createAnswer().then(function(e){t.setLocalDescription(e),p("answer",{id:n,description:{sdp:e.sdp,type:e.type}})},function(){})}),this.onAnswer.listen(function(e){s[e.id].setRemoteDescription(new RTCSessionDescription(e.description))})}}(this);