!function(e){"use strict";function n(e,n){function t(e,n){n.createOffer(function(t){n.setLocalDescription(t),m("offer",{id:e,description:{sdp:t.sdp,type:t.type}})},function(){},g)}function f(e,n){n.createAnswer(function(t){n.setLocalDescription(t),m("answer",{id:e,description:{sdp:t.sdp,type:t.type}})},function(){})}function u(e,n,t){t||(t="dataChannel");var i=n.createDataChannel(t,{reliable:!0});l(e,i)}function l(e,n){n.onopen=function(){},n.onmessage=function(n){R.add({type:"data",id:e,data:n.data})},n.onclose=function(){},w[e]=n}function p(e){var n=new i(D,L);return n.onicecandidate=function(n){null!=n.candidate&&m("candidate",{label:n.candidate.sdpMLineIndex,id:e,candidate:n.candidate.candidate})},n.oniceconnectionstatechange=function(){switch(n.iceConnectionState){case"disconnected":case"failed":n.close();break;case"completed":n.onicecandidate=function(){}}},n.onaddstream=function(n){R.add({type:"add",id:e,stream:n.stream})},n.onremovestream=function(n){R.add({type:"remove",id:e,stream:n.stream})},n.ondatachannel=function(n){l(e,n.channel)},n}function m(e,n){n.type=e,b.send(JSON.stringify(n))}var v=null,h=[],y={},w={},C=[],R=d.control(),S=R.stream,b=new WebSocket(e),g={optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},D={iceServers:[{url:"stun:stun.l.google.com:19302"}]},L={optional:[{DtlsSrtpKeyAgreement:!0}]};b.onopen=function(){m("join",{room:n||""})},b.onerror=function(){},b.onmessage=function(e){R.add(JSON.parse(e.data))},this.onOffer=S.filter(function(e){return"offer"===e.type}),this.onAnswer=S.filter(function(e){return"answer"===e.type}),this.onCandidate=S.filter(function(e){return"candidate"===e.type}),this.onNew=S.filter(function(e){return"new"===e.type}),this.onPeers=S.filter(function(e){return"peers"===e.type}),this.onLeave=S.filter(function(e){return"leave"===e.type}),this.onAdd=S.filter(function(e){return"add"===e.type}),this.onRemove=S.filter(function(e){return"remove"===e.type}),this.onData=S.filter(function(e){return"data"===e.type}),this.broadcast=function(e){for(var n in w)this.send(n,e)},this.send=function(e,n){var t=w[e];"open"===t.readyState&&t.send(n)},this.createStream=function(e,n){var i=c.defer();return o({audio:e,video:n},function(e){s.filter(e),C.push(e);for(var n=0;n<h.length;++n){var o=h[n];y[o]=p(o)}for(n=0;n<C.length;++n){e=C[n];for(o in y){var r=y[o];r.addStream(e)}}for(o in y)r=y[o],u(o,r),t(o,r);i.fulfill(e)},function(){},g),i.promise},this.onPeers.listen(function(e){v=e.you;for(var n in e.connections){var t=e.connections[n];h.push(t)}}),this.onCandidate.listen(function(e){var n=new r({sdpMLineIndex:e.label,candidate:e.candidate});y[e.id].addIceCandidate(n)}),this.onNew.listen(function(e){var n=e.id,t=p(n);h.push(n),y[n]=t,C.forEach(function(e){t.addStream(e)})}),this.onLeave.listen(function(e){var n=e.id;delete y[n],delete w[n],h.splice(h.indexOf(n),1)}),this.onOffer.listen(function(e){var n=y[e.id];n.setRemoteDescription(new a(e.description)),f(e.id,n)}),this.onAnswer.listen(function(e){var n=y[e.id];n.setRemoteDescription(new a(e.description))})}"Window"!=typeof e&&(e=window);var t=e.navigator,i=e.mozRTCPeerConnection||e.webkitRTCPeerConnection||e.PeerConnection,o=(t.getUserMedia||t.webkitGetUserMedia||t.mozGetUserMedia||t.msGetUserMedia).bind(t),r=e.mozRTCIceCandidate||e.RTCIceCandidate,a=e.mozRTCSessionDescription||e.RTCSessionDescription;e.URL=e.URL||e.webkitURL||e.msURL;var d,c,s;"function"==typeof define&&define.amd?define(["streamlet","davy","overtone"],function(e,t,i){return d=e,c=t,s=i,n}):"object"==typeof module&&module.exports?(module.exports=n,d=require("streamlet"),c=require("davy"),s=require("overtone")):(e.Dialup=n,d=e.Streamlet,c=e.Davy,s=e.Overtone)}(this);
//# sourceMappingURL=dialup.min.js.map