!function(e){"use strict";var a,m;"Window"!=typeof e&&(e=window),"function"==typeof define&&define.amd?define(["streamlet","overtone"],function(e,n){return a=e,m=n,t}):m="object"==typeof module&&module.exports?(module.exports=t,a=require("streamlet"),require("overtone")):(e.Dialup=t,a=e.Streamlet,e.Overtone);var v=["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302","stun.ekiga.net","stun.ideasip.com","stun.rixtelecom.se","stun.schlund.de","stun.stunprotocol.org:3478","stun.voiparound.com","stun.voipbuster.com","stun.voipstunt.com","stun.voxgratia.org"].reduce(function(e,n){var t=e[e.length-1];return n="stun:"+n,t&&o(t.urls[0])===o(n)?t.urls.push(n):e.push({urls:[n]}),e},[]);function o(e){return e.replace(/^stun\d*\./,"").replace(/:\d+$/,"")}function t(e,n){const r=[],d={},o={},u=[],t=a.control(),i=t.stream,c=new WebSocket(e),f={offerToReceiveAudio:!0,offerToReceiveVideo:!0},s={iceServers:v};function l(n,e){e.onopen=function(){},e.onmessage=function(e){t.add({type:"data",id:n,data:e.data})},e.onclose=function(){},o[n]=e}function p(n){const e=new RTCPeerConnection(s);return e.onicecandidate=function(e){null!=e.candidate&&h("candidate",{label:e.candidate.sdpMLineIndex,id:n,candidate:e.candidate.candidate})},e.oniceconnectionstatechange=function(){switch(e.iceConnectionState){case"disconnected":case"failed":e.close();break;case"completed":e.onicecandidate=function(){}}},e.onicecandidateerror=function(e){console.log(e)},e.ontrack=function(e){t.add({type:"add",id:n,stream:e.streams[0]})},e.ondatachannel=function(e){l(n,e.channel)},e}function h(e,n){n.type=e,c.send(JSON.stringify(n))}c.onopen=function(){h("join",{room:n||""})},c.onerror=function(){},c.onmessage=function(e){t.add(JSON.parse(e.data))},this.onOffer=i.filter(e=>"offer"===e.type),this.onAnswer=i.filter(e=>"answer"===e.type),this.onCandidate=i.filter(e=>"candidate"===e.type),this.onNew=i.filter(e=>"new"===e.type),this.onPeers=i.filter(e=>"peers"===e.type),this.onLeave=i.filter(e=>"leave"===e.type),this.onAdd=i.filter(e=>"add"===e.type),this.onRemove=i.filter(e=>"remove"===e.type),this.onData=i.filter(e=>"data"===e.type),this.broadcast=function(e){for(const n in o)this.send(n,e)},this.send=function(e,n){const t=o[e];"open"===t.readyState&&t.send(n)},this.createStream=function(e,n){return navigator.mediaDevices.getUserMedia({audio:e,video:n}).then(function(n){m.filter(n),u.push(n);for(const i of r)d[i]=p(i);for(const n of u)for(const c in d){const s=d[c];n.getTracks().forEach(function(e){s.addTrack(e,n)})}for(const a in d){var e=d[a];t=a,o=(o=void 0)||"dataChannel",o=e.createDataChannel(o),!void l(t,o),function(n,t){t.createOffer(f).then(function(e){t.setLocalDescription(e).then(function(){h("offer",{id:n,description:{sdp:e.sdp,type:e.type}})})},function(){})}(a,e)}var t,o;return n})},this.onPeers.listen(function(e){for(const t in e.you,e.connections){var n=e.connections[t];r.push(n)}}),this.onCandidate.listen(function(e){var n=new RTCIceCandidate({sdpMLineIndex:e.label,candidate:e.candidate});d[e.id].addIceCandidate(n).catch(function(e){console.log(e)})}),this.onNew.listen(function(e){const n=e.id,t=p(n);r.push(n),d[n]=t,u.forEach(function(n){n.getTracks().forEach(function(e){t.addTrack(e,n)})})}),this.onLeave.listen(function(e){e=e.id;delete d[e],delete o[e],r.splice(r.indexOf(e),1)}),this.onOffer.listen(function(e){const n=d[e.id];var t,o;n.setRemoteDescription(new RTCSessionDescription(e.description)),t=e.id,(o=n).createAnswer().then(function(e){o.setLocalDescription(e),h("answer",{id:t,description:{sdp:e.sdp,type:e.type}})},function(){})}),this.onAnswer.listen(function(e){const n=d[e.id];n.setRemoteDescription(new RTCSessionDescription(e.description))})}}(this);